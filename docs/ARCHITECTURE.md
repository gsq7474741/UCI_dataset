# 架构设计对比分析

## 一、torchvision 数据集架构

### 1.1 类层次结构

```
torch.utils.data.Dataset (PyTorch核心)
         │
         ▼
torchvision.datasets.VisionDataset (视觉数据集基类)
         │
         ├── ImageFolder        # 通用图像文件夹
         ├── DatasetFolder      # 通用数据文件夹
         │
         ├── MNIST              # 具体数据集
         ├── CIFAR10
         ├── ImageNet
         └── ...
```

### 1.2 VisionDataset 核心设计

```python
class VisionDataset(torch.utils.data.Dataset):
    """torchvision数据集基类"""
    
    def __init__(
        self,
        root: str,                           # 数据根目录
        transforms: Optional[Callable],       # 联合转换 (data, target)
        transform: Optional[Callable],        # 数据转换
        target_transform: Optional[Callable], # 标签转换
    ):
        self.root = root
        self.transforms = transforms
        self.transform = transform
        self.target_transform = target_transform
    
    def __getitem__(self, index: int) -> Tuple[Any, Any]:
        raise NotImplementedError
    
    def __len__(self) -> int:
        raise NotImplementedError
```

### 1.3 torchvision 关键设计模式

| 设计模式 | 说明 |
|----------|------|
| **统一接口** | 所有数据集实现 `__getitem__` 和 `__len__` |
| **transform分离** | 数据转换与数据集解耦，可组合 |
| **download参数** | 支持自动下载 |
| **split参数** | 支持train/val/test划分 |
| **懒加载** | 按需加载单个样本，节省内存 |
| **DataLoader兼容** | 可直接传给DataLoader批量加载 |

### 1.4 torchvision.transforms 架构

```
transforms.Compose([
    transforms.Resize(256),
    transforms.CenterCrop(224),
    transforms.ToTensor(),
    transforms.Normalize(mean, std),
])
```

---

## 二、当前 enose_uci_dataset 架构

### 2.1 当前类层次结构

```
BaseDataset (抽象基类)
     │
     ▼
ENoseDataset (电子鼻数据集)
     │
     └── 通过name参数区分不同数据集
```

### 2.2 当前模块结构

```
enose_uci_dataset/
├── config_loader.py    # 配置加载
├── downloader.py       # 下载器
├── extractor.py        # 解压器
├── dataset.py          # 数据集类
├── transforms.py       # 转换模块
├── datasets.yaml       # 数据集注册
└── config.yaml         # 运行配置
```

### 2.3 当前问题

| 问题 | 描述 |
|------|------|
| **预加载所有数据** | `_load_data`一次加载所有样本到内存 |
| **缺少具体数据集类** | 所有数据集共用一个类，缺乏针对性 |
| **transforms不够完善** | 缺少时序数据特有的转换 |
| **缺少数据增强** | 没有针对传感器数据的增强方法 |
| **缺少标准化的输出格式** | 不同数据集输出格式不统一 |

---

## 三、架构对比图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           torchvision 架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                │
│  │ torch.data   │     │  transforms  │     │  DataLoader  │                │
│  │   .Dataset   │────▶│   .Compose   │────▶│   (batch)    │                │
│  └──────┬───────┘     └──────────────┘     └──────────────┘                │
│         │                                                                   │
│         ▼                                                                   │
│  ┌──────────────┐                                                          │
│  │VisionDataset │  ← 统一基类                                               │
│  │  - root      │                                                          │
│  │  - transform │                                                          │
│  │  - download  │                                                          │
│  └──────┬───────┘                                                          │
│         │                                                                   │
│    ┌────┴────┬────────┬────────┐                                           │
│    ▼         ▼        ▼        ▼                                           │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                                        │
│ │MNIST │ │CIFAR │ │ImgNet│ │Custom│  ← 具体数据集类                         │
│ └──────┘ └──────┘ └──────┘ └──────┘                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                      enose_uci_dataset 当前架构                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                │
│  │ config.yaml  │     │datasets.yaml │     │ downloader   │                │
│  │  (运行配置)   │     │ (数据集注册)  │     │  (下载器)    │                │
│  └──────────────┘     └──────┬───────┘     └──────────────┘                │
│                              │                                              │
│                              ▼                                              │
│                       ┌──────────────┐                                      │
│                       │ ENoseDataset │  ← 单一通用类                        │
│                       │  - name      │                                      │
│                       │  - transform │                                      │
│                       │  - samples[] │  ← 预加载到内存                      │
│                       └──────────────┘                                      │
│                                                                             │
│  问题: 缺少具体数据集类，所有逻辑混在一起                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                      enose_uci_dataset 改进架构                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │                     配置层 (Config Layer)                     │          │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │          │
│  │  │ datasets.yaml│  │ config.yaml  │  │ metadata.json│        │          │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              │                                              │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │                     基础设施层 (Infrastructure)               │          │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │          │
│  │  │  downloader  │  │  extractor   │  │   registry   │        │          │
│  │  │  (断点续传)   │  │  (ZipTurbo)  │  │  (配置加载)   │        │          │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              │                                              │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │                     数据集层 (Dataset Layer)                  │          │
│  │                                                               │          │
│  │            ┌─────────────────────────────┐                   │          │
│  │            │      ENoseDataset           │ ← 抽象基类         │          │
│  │            │  - root, transform          │                   │          │
│  │            │  - __getitem__ (懒加载)      │                   │          │
│  │            │  - download()               │                   │          │
│  │            └─────────────┬───────────────┘                   │          │
│  │                          │                                    │          │
│  │     ┌────────────────────┼────────────────────┐              │          │
│  │     ▼                    ▼                    ▼              │          │
│  │ ┌────────────┐    ┌────────────┐    ┌────────────┐          │          │
│  │ │HomeActivity│    │TwinSensor │    │DynamicGas  │ ← 具体类   │          │
│  │ │  Dataset   │    │  Dataset  │    │  Dataset   │           │          │
│  │ └────────────┘    └────────────┘    └────────────┘          │          │
│  │                                                               │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              │                                              │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │                     转换层 (Transform Layer)                  │          │
│  │                                                               │          │
│  │  ┌────────────────────────────────────────────────────────┐  │          │
│  │  │                    Compose                              │  │          │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │          │
│  │  │  │Normalize │ │ Resample │ │ Window   │ │ Augment  │   │  │          │
│  │  │  │ Columns  │ │ (重采样) │ │ (切片)   │ │ (增强)   │   │  │          │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │          │
│  │  └────────────────────────────────────────────────────────┘  │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              │                                              │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │                     任务适配层 (Task Adapter)                 │          │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │          │
│  │  │ Classification│ │ Regression  │  │ TimeSeries   │        │          │
│  │  │   Adapter    │  │   Adapter   │  │   Adapter    │        │          │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、改进方案

### 4.1 核心改进点

| 改进项 | 当前 | 改进后 |
|--------|------|--------|
| **数据加载** | 预加载所有到内存 | 懒加载 (按需读取) |
| **数据集类** | 单一通用类 | 具体数据集类继承基类 |
| **样本索引** | 加载时构建 | 预先构建索引文件 |
| **transforms** | 基础转换 | 添加时序增强 |
| **输出格式** | DataFrame | 支持numpy/tensor |

### 4.2 新增组件

1. **SampleIndex** - 样本索引，支持懒加载
2. **具体数据集类** - 每个数据集一个类
3. **TimeSeriesAugmentation** - 时序数据增强
4. **TaskAdapter** - 任务适配器

---

## 五、实现计划

1. 重构 `ENoseDataset` 支持懒加载
2. 创建具体数据集类
3. 添加时序数据增强转换
4. 创建任务适配器
